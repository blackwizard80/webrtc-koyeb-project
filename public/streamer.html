<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebRTC Streamer (Site A)</title>
    <style>
        body { font-family: sans-serif; text-align: center; }
        video { width: 100%; max-width: 600px; border: 2px solid red; background: #000; display: none }
    </style>
</head>
<body>
    <h1>Streamer (Site A) - කැමරාව යවන අඩවිය</h1>
    <video id="localVideo" autoplay playsinline muted></video>
    <p>Status: <span id="status">Starting Camera...</span></p>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io(); 
        const localVideo = document.getElementById('localVideo');
        const statusEl = document.getElementById('status');
        
        let localStream;
        let peerConnection;

        const configuration = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        // 1. මුලින්ම කැමරාව පමණක් On කරගන්න (Connection හදන්නේ නෑ)
        async function startCamera() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                localVideo.srcObject = localStream;
                statusEl.textContent = 'Camera ready. Waiting for Viewer...';
            } catch (error) {
                console.error('Camera Error:', error);
                statusEl.textContent = 'Camera Error: ' + error.message;
            }
        }

        // 2. Viewer කෙනෙක් ආවාම ("watcher" event එක ලැබුනම) Connection එක පටන් ගන්න
        socket.on('watcher', async () => {
            statusEl.textContent = 'Viewer detected. Connecting...';
            
            // පරණ connection එකක් තිබේ නම් අයින් කරන්න
            if (peerConnection) peerConnection.close();

            createPeerConnection();
            await createOffer();
        });

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);

            // Stream එක Add කරන්න
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // ICE Candidates යවන්න
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', { candidate: event.candidate });
                }
            };

            peerConnection.onconnectionstatechange = () => {
                statusEl.textContent = `Connection State: ${peerConnection.connectionState}`;
            };
        }

        async function createOffer() {
            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                socket.emit('offer', { sdp: peerConnection.localDescription });
            } catch (error) {
                console.error('Error creating offer:', error);
            }
        }

        // Viewer ගෙන් Answer එක ලැබුනම
        socket.on('answer', async (data) => {
            if (peerConnection) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
            }
        });

        // Viewer ගෙන් ICE Candidates ලැබුනම
        socket.on('ice-candidate', async (data) => {
            try {
                if (peerConnection && data.candidate) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            } catch (e) { console.error('Error adding candidate:', e); }
        });

        // Page එක load වුන ගමන් කැමරාව On කරන්න
        startCamera();
        
    </script>
</body>
</html>
