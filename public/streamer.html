<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebRTC Streamer (Site A)</title>
    <style>
        /* Streamer වීඩියෝවට ස්ථිර ප්‍රමාණයක් දෙන්න */
        #localVideo {
            width: 320px;
            height: 240px; /* උස නියම කිරීමෙන් ප්‍රදර්ශනය තහවුරු කරයි */
            border: 1px solid red;
        }
    </style>
</head>
<body>
    <h1>Streamer (Site A) - කැමරාව යවන අඩවිය</h1>
    <video id="localVideo" autoplay playsinline muted></video>
    <p>Status: <span id="status">Connecting automatically...</span></p>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Server එකේ URL එක නොදී io() කැඳවීමෙන්, එය වත්මන් Host වෙත සම්බන්ධ වීමට උත්සාහ කරයි.
        const socket = io(); 
        const localVideo = document.getElementById('localVideo');
        const statusEl = document.getElementById('status');
        let localStream;
        let peerConnection;

        // STUN Server Configuration
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        // 1. කැමරාව ආරම්භ කර WebRTC සම්බන්ධතාවය ගොඩනැගීමේ ප්‍රධාන ශ්‍රිතය
        async function startStream() {
            try {
                // කැමරා ප්‍රවේශය ඉල්ලීම: Video පමණක් ඉල්ලයි, Audio ඉවත් කර ඇත.
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                
                // Local Stream එක localVideo element එකට සම්බන්ධ කිරීම
                localVideo.srcObject = localStream;
                statusEl.textContent = 'Camera started. Connecting...';
                
                createPeerConnection();
                createOffer(); 
            } catch (error) {
                console.error('Error accessing media devices.', error);
                // පරිශීලකයා අවසරය ප්‍රතික්ෂේප කළහොත් පණිවිඩය පෙන්වයි
                statusEl.textContent = `Error: ${error.name}. Camera access denied or HTTPS required.`;
            }
        }

        // 2. Peer Connection එක නිර්මාණය කිරීම
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);

            // Local Stream එකේ Tracks Peer Connection එකට එකතු කිරීම
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            // ICE Candidate සේවාදායකය හරහා B අඩවියට යැවීම
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', { candidate: event.candidate, id: socket.id });
                }
            };
            
            // Connection State වෙනස් වූ විට තත්ත්වය යාවත්කාලීන කිරීම
            peerConnection.onconnectionstatechange = () => {
                statusEl.textContent = `Connection State: ${peerConnection.connectionState}`;
                console.log('Peer Connection State:', peerConnection.connectionState);
            };
        }

        // 3. SDP Offer එකක් නිර්මාණය කිරීම
        async function createOffer() {
            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                socket.emit('offer', { 
                    sdp: peerConnection.localDescription, 
                    id: socket.id 
                });
                statusEl.textContent = 'Offer sent. Waiting for Answer...';
            } catch (error) {
                console.error('Error creating offer:', error);
            }
        }

        // 4. B අඩවියෙන් එන SDP Answer එක පිළිගැනීම
        socket.on('answer', async (data) => {
            if (!peerConnection.currentRemoteDescription) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
                statusEl.textContent = 'Connected (Answer Received)';
            }
        });

        // 5. ICE Candidate B අඩවියෙන් ලැබුන විට එකතු කිරීම
        socket.on('ice-candidate', async (data) => {
            try {
                if (data.candidate && peerConnection.remoteDescription) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            } catch (error) {
                console.error('Error adding ICE candidate:', error);
            }
        });
        
        // ** පිටුව පූරණය වූ පසු ස්වයංක්‍රීයව ආරම්භ කිරීම **
        window.onload = startStream;
        
    </script>
</body>
</html>
